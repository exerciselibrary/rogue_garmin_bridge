{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Device Management</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info mb-4">
                    Web Bluetooth connections now live on the Workout tab so you can stay connected while tracking.
                    Head there to pair via Safari/Chrome/Bluefy without losing your session.
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Discover Devices</h5>
                    </div>
                    <div class="card-body">
                        <p>Scan for Rogue Echo Bike and Rower devices in range.</p>
                        <button id="discover-btn" class="btn btn-primary">
                            <span id="discover-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Discover Devices
                        </button>
                        <div id="discover-status" class="mt-2"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Device List</h5>
                    </div>
                    <div class="card-body">
                        <div id="device-list">
                            <p>No devices found. Click "Discover Devices" to scan for devices.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Connected Device</h5>
                    </div>
                    <div class="card-body">
                        <div id="connected-device">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Status:</strong> <span id="status-text" class="badge bg-secondary">Disconnected</span></p>
                                    <p><strong>Device:</strong> <span id="device-name">None</span></p>
                                    <p><strong>Type:</strong> <span id="device-type">Unknown</span></p>
                                    <p><strong>Address:</strong> <span id="device-address">None</span></p>
                                </div>
                                <div class="col-md-6">
                                    <div id="connection-quality" class="d-none">
                                        <p><strong>Signal Strength:</strong> <span id="signal-strength" class="badge bg-info">Unknown</span></p>
                                        <p><strong>Connection Time:</strong> <span id="connection-time">--:--:--</span></p>
                                        <p><strong>Data Rate:</strong> <span id="data-rate">0 Hz</span></p>
                                        <p><strong>Last Data:</strong> <span id="last-data-time">Never</span></p>
                                    </div>
                                </div>
                            </div>
                            <div id="auto-reconnect-status" class="alert alert-info d-none mt-2">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span>Attempting to reconnect... <span id="reconnect-attempt">1</span>/5</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="disconnect-btn" class="btn btn-danger" disabled>Disconnect</button>
                            <button id="reconnect-btn" class="btn btn-warning d-none">Reconnect</button>
                            <button id="diagnostic-btn" class="btn btn-info">Run Diagnostics</button>
                            <a href="/workout" class="btn btn-success">Go to Workout</a>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Device Pairing Wizard</h5>
                        <button id="start-wizard-btn" class="btn btn-sm btn-primary">Start Wizard</button>
                    </div>
                    <div class="card-body">
                        <div id="pairing-wizard" class="d-none">
                            <div id="wizard-step-1" class="wizard-step">
                                <h6>Step 1: Prepare Your Device</h6>
                                <div class="mb-3">
                                    <label class="form-label">Select your device type:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="wizard-device-type" id="wizard-bike" value="bike">
                                        <label class="form-check-label" for="wizard-bike">Rogue Echo Bike</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="wizard-device-type" id="wizard-rower" value="rower">
                                        <label class="form-check-label" for="wizard-rower">Rogue Echo Rower</label>
                                    </div>
                                </div>
                                <div id="device-instructions" class="alert alert-info d-none"></div>
                                <button id="wizard-next-1" class="btn btn-primary" disabled>Next</button>
                            </div>
                            
                            <div id="wizard-step-2" class="wizard-step d-none">
                                <h6>Step 2: Enable Pairing Mode</h6>
                                <div id="pairing-instructions" class="mb-3"></div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="pairing-mode-ready">
                                    <label class="form-check-label" for="pairing-mode-ready">
                                        My device is now in pairing mode (Bluetooth icon flashing)
                                    </label>
                                </div>
                                <button id="wizard-back-2" class="btn btn-secondary me-2">Back</button>
                                <button id="wizard-next-2" class="btn btn-primary" disabled>Scan for Devices</button>
                            </div>
                            
                            <div id="wizard-step-3" class="wizard-step d-none">
                                <h6>Step 3: Connect to Device</h6>
                                <p>Scanning for devices...</p>
                                <div id="wizard-device-list"></div>
                                <button id="wizard-back-3" class="btn btn-secondary me-2">Back</button>
                                <button id="wizard-finish" class="btn btn-success d-none">Finish</button>
                            </div>
                        </div>
                        
                        <div id="wizard-help" class="mt-3">
                            <p><strong>Need help?</strong> The wizard will guide you through connecting your Rogue Echo equipment step by step.</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Troubleshooting & Diagnostics</h5>
                        <button id="toggle-troubleshooting" class="btn btn-sm btn-outline-secondary">Show Details</button>
                    </div>
                    <div class="card-body">
                        <div id="diagnostic-results" class="d-none mb-3">
                            <h6>System Diagnostics</h6>
                            <div id="diagnostic-output" class="bg-light p-3 rounded">
                                <p>Click "Run Diagnostics" to check system status...</p>
                            </div>
                        </div>
                        
                        <div id="troubleshooting-guide" class="d-none">
                            <h6>Common Connection Issues</h6>
                            <div class="accordion" id="troubleshootingAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingOne">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                            Device not found during scan
                                        </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                        <div class="accordion-body">
                                            <ul>
                                                <li>Ensure your device is powered on and in pairing mode</li>
                                                <li>Check that Bluetooth is enabled on your computer</li>
                                                <li>Move closer to the device (within 10 feet)</li>
                                                <li>Restart your Rogue Echo equipment</li>
                                                <li>Check if the device is connected to another app</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingTwo">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                            Connection drops frequently
                                        </button>
                                    </h2>
                                    <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                        <div class="accordion-body">
                                            <ul>
                                                <li>Check for interference from other Bluetooth devices</li>
                                                <li>Ensure stable power supply to your equipment</li>
                                                <li>Update your computer's Bluetooth drivers</li>
                                                <li>Try moving closer to reduce signal interference</li>
                                                <li>Restart the application and try reconnecting</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="headingThree">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                            Data appears incorrect or missing
                                        </button>
                                    </h2>
                                    <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                        <div class="accordion-body">
                                            <ul>
                                                <li>Verify your device type selection is correct</li>
                                                <li>Check that you're actively using the equipment (pedaling/rowing)</li>
                                                <li>Ensure proper calibration of your equipment</li>
                                                <li>Try disconnecting and reconnecting</li>
                                                <li>Check the connection quality indicators</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="connection-help-basic">
                            <p><strong>Quick Setup:</strong></p>
                            <ol>
                                <li><strong>Echo Bike:</strong> Hold "Connect" button for 2 seconds until you hear beeps</li>
                                <li><strong>Echo Rower:</strong> Select "Connect" â†’ "Connect to App" from the menu</li>
                                <li>Click "Discover Devices" above and select your equipment</li>
                                <li>Start your workout!</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/device-management.js') }}"></script>
{% endblock %}
