# Testing Docker Compose configuration
version: '3.8'

services:
  test-unit:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rogue-garmin-bridge-test-unit
    volumes:
      - .:/app
      - /app/venv
    environment:
      - TESTING=True
      - DATABASE_URL=sqlite:///:memory:
      - LOG_LEVEL=WARNING
      - USE_SIMULATOR=True
    command: ["pytest", "tests/unit/", "-v", "--cov=src", "--cov-report=term"]

  test-integration:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rogue-garmin-bridge-test-integration
    volumes:
      - .:/app
      - /app/venv
    environment:
      - TESTING=True
      - DATABASE_URL=sqlite:///:memory:
      - LOG_LEVEL=WARNING
      - USE_SIMULATOR=True
    command: ["pytest", "tests/integration/", "-v", "--cov=src", "--cov-report=term"]

  test-performance:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rogue-garmin-bridge-test-performance
    volumes:
      - .:/app
      - /app/venv
    environment:
      - TESTING=True
      - DATABASE_URL=sqlite:///:memory:
      - LOG_LEVEL=WARNING
      - USE_SIMULATOR=True
    command: ["pytest", "tests/performance/", "-v", "-m", "not slow"]

  test-all:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rogue-garmin-bridge-test-all
    volumes:
      - .:/app
      - /app/venv
      - test_coverage:/app/htmlcov
    environment:
      - TESTING=True
      - DATABASE_URL=sqlite:///:memory:
      - LOG_LEVEL=WARNING
      - USE_SIMULATOR=True
    command: [
      "sh", "-c", 
      "pytest --cov=src --cov-report=html --cov-report=term --cov-report=xml && 
       echo 'Coverage report generated in htmlcov/'"
    ]

  lint:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: rogue-garmin-bridge-lint
    volumes:
      - .:/app
      - /app/venv
    command: [
      "sh", "-c",
      "black --check src/ tests/ && 
       isort --check-only src/ tests/ && 
       flake8 src/ tests/ && 
       mypy src/ &&
       echo 'All linting checks passed'"
    ]

volumes:
  test_coverage:
    driver: local